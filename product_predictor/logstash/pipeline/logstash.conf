# Create this file as: logstash/pipeline/logstash.conf

input {
  file {
    path => "/app/logs/ml_api.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "json_lines"
    tags => ["ml_api"]
  }
  
  file {
    path => "/app/logs/predictions.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "json_lines"
    tags => ["predictions"]
  }
  
  file {
    path => "/app/logs/errors.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "json_lines"
    tags => ["errors"]
  }
}

filter {
  # Add service name
  mutate {
    add_field => { "service" => "product-predictor" }
  }
  
  # Parse timestamp if present
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  }
  
  # Handle prediction logs specifically
  if "predictions" in [tags] {
    mutate {
      add_field => { "log_type" => "prediction" }
    }
  }
  
  # Handle error logs specifically
  if "errors" in [tags] {
    mutate {
      add_field => { "log_type" => "error" }
      add_field => { "severity" => "high" }
    }
  }
  
  # Handle API logs
  if "ml_api" in [tags] {
    mutate {
      add_field => { "log_type" => "api" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "ml-app-logs-%{+YYYY.MM.dd}"
    template_name => "ml-app-template"
  }
  
  # Debug output (comment out in production)
  stdout {
    codec => rubydebug
  }
}